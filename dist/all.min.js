function formatInformacoesDeputado(e,o){e=e.replace(/\s{2,}/g,"");var r=e.split("-"),t=r[0].split(":")[1];o.party=t.split("/")[0].replace(" ",""),o.state=t.split("/")[1].replace(" ","");var n=r[3].split(":")[1].replace(" ","");o.phone=n+"-"+r[4]}function parseHtmlToJson(e){var o=[];jsdom.env(e,["http://code.jquery.com/jquery.js"],function(e,r){var t=r.jQuery,n=t("#content").find("ul#demaisInformacoes");n.each(function(e,r){var n={},s=t(this),a=s.find("li");a.each(function(e,o){if(0===e){n.fullName=t(this).find("a").first().text();t(this).find("a:first").attr("href")}else if(1==e){var r=t(this).text();formatInformacoesDeputado(r,n)}}),o.push(n)}),client.post("/api",o,function(e,o,r,t){e?console.log("An error ocurred:",e):console.log("New list of deputados is posted")})})}function callback(e,o,r){e||200!=o.statusCode||parseHtmlToJson(r)}var request=require("request"),jsdom=require("jsdom"),express=require("express"),restify=require("restify"),deputadoController=require("./deputadoController.js"),server=restify.createServer({name:"myapp",version:"1.0.0"});server.use(restify.acceptParser(server.acceptable)),server.use(restify.queryParser()),server.use(restify.bodyParser()),server.listen(3e3,function(){console.log("%s listening at %s",server.name,server.url)}),server.get("/",function(e,o,r){deputadoController.list(function(e){for(var r="<h2>LISTA DE DEPUTADOS</h2>",t='<table style="width:100%;border:1px solid black;">',n=0;n<e.length;n++)t+='<tr style="border:1px solid black;">',t=t+'<td style="border:1px solid black;">'+e[n]._doc.fullName,t=t+'<td style="border:1px solid black;">'+e[n]._doc.birthday,t=t+'<td style="border:1px solid black;">'+e[n]._doc.party,t=t+'<td style="border:1px solid black;">'+e[n]._doc.state,t=t+'<td style="border:1px solid black;">'+e[n]._doc.main,t=t+'<td style="border:1px solid black;">'+e[n]._doc.phone,t+="</tr>";t+="</table>";var s='<html><head><meta charset="utf-8" /><head><body>'+r+"<br>"+t+"</body></html>";o.writeHead(200,{"Content-Length":Buffer.byteLength(s),"Content-Type":"text/html"}),o.write(s),o.end()})}),server.post("/api",function(e,o,r){deputadoController.save(e.params,function(e){o.json(e)})});var client=restify.createJsonClient({url:"http://localhost:3000",version:"1.0.0"}),options={url:"http://www.camara.leg.br/internet/deputado/Dep_Lista.asp?Legislatura=55&Partido=QQ&SX=QQ&Todos=None&UF=QQ&condic=QQ&forma=lista&nome=&ordem=nome&origem=None",headers:{"User-Agent":"Mozilla/5.0"}};request(options,callback);var minutes=5,the_interval=60*minutes*1e3;setInterval(function(){console.log("I am doing my 5 minutes check"),request(options,callback)},the_interval);var db_string="mongodb://localhost:27017/recruitmentdb2",mongoose=require("mongoose").connect(db_string),db=mongoose.connection;db.on("error",console.error.bind(console,"Erro ao conectar no banco")),db.once("open",function(){var e=mongoose.Schema({fullname:String,birthday:String,party:String,state:String,main:Boolean,phone:String});exports.Deputado=mongoose.model("Deputado",e)});var db=require("./db_config.js");exports.list=function(e){db.Deputado.find({},function(o,r){o?console.log("An error ocurred"+o):e(r)})},exports.save=function(e,o){db.Deputado.collection.remove(),db.Deputado.collection.insertMany(e,function(e,o){e?console.log("An error ocurred:"+e):console.log("Json save on DB")})};